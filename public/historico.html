const API_URL = window.location.origin + "/historico";
const CAPACIDADES = {
  "Reservatorio_Elevador_current": 20000,
  "Reservatorio_Osmose_current": 200,
  "Reservatorio_CME_current": 1000,
  "Reservatorio_Agua_Abrandada_current": 9000,
};

const NOMES = {
  "Reservatorio_Elevador_current": "Reservatório Elevador",
  "Reservatorio_Osmose_current": "Reservatório Osmose",
  "Reservatorio_CME_current": "Reservatório CME",
  "Reservatorio_Agua_Abrandada_current": "Água Abrandada",
};

let chart;
let historicoGlobal = [];

document.addEventListener("DOMContentLoaded", async () => {
  const select = document.getElementById("reservatorioSelect");
  select.addEventListener("change", () => atualizarHistorico(select.value));
  await carregarHistoricoInicial();
});

async function carregarHistoricoInicial() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("Erro ao carregar histórico");
    historicoGlobal = await res.json();

    const select = document.getElementById("reservatorioSelect");
    atualizarHistorico(select.value);
  } catch (err) {
    console.error(err);
    alert("Erro ao carregar histórico");
  }
}

function atualizarHistorico(reservatorio) {
  const ultimas24h = filtrarUltimas24h(historicoGlobal);
  const registros = ultimas24h
    .filter(h => h[reservatorio] !== undefined)
    .map(h => ({
      data: new Date(h.timestamp),
      litros: h[reservatorio]
    }));

  exibirHistorico(reservatorio, registros);
}

function filtrarUltimas24h(dados) {
  const agora = Date.now();
  return dados.filter(d => agora - new Date(d.timestamp).getTime() <= 24 * 60 * 60 * 1000);
}

function exibirHistorico(reservatorio, registros) {
  const container = document.getElementById("historicoContainer");
  const nome = NOMES[reservatorio] || reservatorio;
  const capacidade = CAPACIDADES[reservatorio] || 1;

  document.getElementById("tituloHistorico").textContent = `Histórico — ${nome}`;

  if (registros.length === 0) {
    container.innerHTML = `<p>Nenhum dado encontrado nas últimas 24 horas.</p>`;
    if (chart) chart.destroy();
    return;
  }

  const ctx = document.getElementById("grafico").getContext("2d");
  if (chart) chart.destroy();

  const labels = registros.map(r =>
    r.data.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })
  );
  const data = registros.map(r => r.litros);
  const nivelAtual = data[data.length - 1];

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: `${nome} (L)`,
          data,
          borderColor: "#004b8d",
          backgroundColor: "rgba(0, 75, 141, 0.1)",
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: "#004b8d"
        },
        {
          label: "Nível Atual",
          data: Array(data.length).fill(nivelAtual),
          borderColor: "#ff6600",
          borderDash: [6, 6],
          pointRadius: 0,
          tension: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: capacidade,
          title: { display: true, text: "Litros" }
        },
        x: {
          title: { display: true, text: "Horário" }
        }
      },
      plugins: {
        legend: { position: "bottom" },
        tooltip: { mode: "index", intersect: false }
      },
      interaction: {
        mode: "nearest",
        intersect: false
      }
    }
  });

  // === TABELA (mudança >5%) ===
  let linhas = [];
  let anterior = registros[0].litros;
  linhas.push(gerarLinha(registros[0], capacidade));

  for (let i = 1; i < registros.length; i++) {
    const diff = Math.abs(((registros[i].litros - anterior) / capacidade) * 100);
    if (diff >= 5) {
      linhas.push(gerarLinha(registros[i], capacidade));
      anterior = registros[i].litros;
    }
  }

  container.innerHTML = `
    <table>
      <thead>
        <tr><th>Data/Hora</th><th>Leitura (L)</th><th>Ocupação (%)</th></tr>
      </thead>
      <tbody>${linhas.join("")}</tbody>
    </table>`;
}

function gerarLinha(registro, capacidade) {
  const ocupacao = ((registro.litros / capacidade) * 100).toFixed(1);
  return `<tr>
    <td>${registro.data.toLocaleString("pt-BR")}</td>
    <td>${registro.litros.toLocaleString("pt-BR")}</td>
    <td>${ocupacao}%</td>
  </tr>`;
}
